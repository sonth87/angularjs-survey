angular.module("mwFormViewer",["ngSanitize","ui.bootstrap","ng-sortable","pascalprecht.translate"]),angular.module("mwFormViewer").directive("mwPriorityList",function(){return{replace:!0,restrict:"AE",require:"^mwFormQuestion",scope:{question:"=",questionResponse:"=",readOnly:"=?",options:"=?"},templateUrl:"/mw-priority-list.html",controllerAs:"ctrl",bindToController:!0,controller:function(){function e(e){if(e)for(var n=0;n<e.length;n++){var t=e[n];t.priority=n+1}}function n(e){e.sort(function(e,n){return e.priority-n.priority})}var t=this;this.$onInit=function(){t.questionResponse.priorityList||(t.questionResponse.priorityList=[]),t.idToItem={},n(t.questionResponse.priorityList),t.availableItems=[],t.question.priorityList.forEach(function(e){t.idToItem[e.id]=e;var n=t.questionResponse.priorityList.some(function(n){return e.id==n.id});n||t.availableItems.push({priority:null,id:e.id})}),t.allItemsOrdered=0==t.availableItems.length||null;var r={disabled:t.readOnly,ghostClass:"beingDragged"};t.orderedConfig=angular.extend({},r,{group:{name:"A",pull:!1,put:["B"]},onEnd:function(n,r){e(t.questionResponse.priorityList)}}),t.availableConfig=angular.extend({},r,{sort:!1,group:{name:"B",pull:["A"],put:!1},onEnd:function(n,r){e(t.questionResponse.priorityList),t.allItemsOrdered=0==t.availableItems.length||null}})},1===angular.version.major&&angular.version.minor<5&&this.$onInit()},link:function(e,n,t,r){var s=e.ctrl;s.print=r.print}}}),angular.module("mwFormViewer").directive("mwFormViewer",["$rootScope",function(e){return{replace:!0,restrict:"AE",scope:{formData:"=",responseData:"=",templateData:"=?",readOnly:"=?",options:"=?",formStatus:"=?",onSubmit:"&",api:"=?"},templateUrl:"/mw-form-viewer.html",controllerAs:"ctrl",bindToController:!0,controller:["$scope","$timeout","$interpolate",function(n,t,r){function s(){o.formData.pages.sort(function(e,n){return e.number-n.number})}var o=this;o.$onInit=function(){o.defaultOptions={nestedForm:!1,autoStart:!1,disableSubmit:!1,isOpen:!1},o.options=angular.extend({},o.defaultOptions,o.options),o.submitStatus="NOT_SUBMITTED",o.formSubmitted=!1,s(),o.pageIdToPage={},o.formData.pages.forEach(function(e){o.pageIdToPage[e.id]=e}),o.buttons={prevPage:{visible:!1,disabled:!1},nextPage:{visible:!1,disabled:!1},submitForm:{visible:!1,disabled:!1}},o.resetPages(),o.api&&(o.api.reset=function(){for(var e in o.responseData)o.responseData.hasOwnProperty(e)&&delete o.responseData[e];o.buttons.submitForm.visible=!1,o.buttons.prevPage.visible=!1,o.buttons.nextPage.visible=!1,o.currentPage=null,t(o.resetPages,0)})},o.submitForm=function(){o.formSubmitted=!0,o.submitStatus="IN_PROGRESS",o.setCurrentPage(null);var e=o.onSubmit();e.then(function(){o.submitStatus="SUCCESS"})["catch"](function(){o.submitStatus="ERROR"}),n.$parent.ctrl.submitForm()},o.setCurrentPage=function(e){return o.currentPage=e,e?(o.setDefaultNextPage(),void o.initResponsesForCurrentPage()):(o.buttons.submitForm.visible=!1,o.buttons.prevPage.visible=!1,void(o.buttons.nextPage.visible=!1))},o.setDefaultNextPage=function(){var e=o.formData.pages.indexOf(o.currentPage);if(o.currentPage.isFirst=0==e,o.currentPage.isLast=e==o.formData.pages.length-1,o.buttons.submitForm.visible=o.currentPage.isLast,o.buttons.prevPage.visible=!o.currentPage.isFirst,o.buttons.nextPage.visible=!o.currentPage.isLast,o.currentPage.isLast?o.nextPage=null:o.nextPage=o.formData.pages[e+1],o.currentPage.pageFlow){var n=!1;o.currentPage.pageFlow.formSubmit?(o.nextPage=null,n=!0):o.currentPage.pageFlow.page?(o.nextPage=o.pageIdToPage[o.currentPage.pageFlow.page.id],o.buttons.nextPage.visible=!0):o.currentPage.isLast&&(o.nextPage=null,n=!0),o.buttons.submitForm.visible=n,o.buttons.nextPage.visible=!n}},o.initResponsesForCurrentPage=function(){o.currentPage.elements.forEach(function(e){var n=e.question;n&&!o.responseData[n.id]&&(o.responseData[n.id]={})})},o.beginResponse=function(){o.formData.pages.length>0&&(o.setCurrentPage(o.formData.pages[0]),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:o.currentPage}))},o.resetPages=function(){o.prevPages=[],o.currentPage=null,o.nextPage=null,o.formSubmitted=!1,o.options.autoStart&&o.beginResponse()},o.goToPrevPage=function(){var n=o.prevPages.pop();o.setCurrentPage(n),o.updateNextPageBasedOnAllAnswers(),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:o.currentPage})},o.goToNextPage=function(){o.prevPages.push(o.currentPage),o.updateNextPageBasedOnAllAnswers(),o.setCurrentPage(o.nextPage),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:o.currentPage})},o.updateNextPageBasedOnAllAnswers=function(){o.currentPage.elements.forEach(function(e){o.updateNextPageBasedOnPageElementAnswers(e)}),o.buttons.submitForm.visible=!o.nextPage,o.buttons.nextPage.visible=!!o.nextPage},o.updateNextPageBasedOnPageElementAnswers=function(e){var n=e.question;n&&n.pageFlowModifier&&n.offeredAnswers.forEach(function(e){e.pageFlow&&o.responseData[n.id].selectedAnswer==e.id&&(e.pageFlow.formSubmit?o.nextPage=null:e.pageFlow.page&&(o.nextPage=o.pageIdToPage[e.pageFlow.page.id]))})},o.onResponseChanged=function(e){o.setDefaultNextPage(),o.updateNextPageBasedOnAllAnswers()},o.print=function(e){return e&&o.templateData?r(e)(o.templateData):e},1===angular.version.major&&angular.version.minor<5&&o.$onInit()}],link:function(n,t,r){var s=n.ctrl;s.formStatus&&(s.formStatus.form=s.form),n.$on("mwForm.pageEvents.changePage",function(n,t){if("undefined"!=typeof t.page&&t.page<s.formData.pages.length){s.resetPages();for(var r=0;r<t.page;r++)s.prevPages.push(s.formData.pages[r]);var o=s.formData.pages[t.page];s.setCurrentPage(o),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:o}),s.updateNextPageBasedOnAllAnswers()}})}}}]),angular.module("mwFormViewer").factory("FormQuestionId",function(){var e=0;return{next:function(){return++e}}}).directive("mwFormQuestion",function(){return{replace:!0,restrict:"AE",require:"^mwFormViewer",scope:{question:"=",questionResponse:"=",readOnly:"=?",options:"=?",onResponseChanged:"&?"},templateUrl:"/mw-form-question.html",controllerAs:"ctrl",bindToController:!0,controller:["$scope","$timeout","FormQuestionId",function(e,n,t){var r=this;this.$onInit=function(){r.id=t.next(),"radio"==r.question.type?(r.questionResponse.selectedAnswer||(r.questionResponse.selectedAnswer=null),r.questionResponse.other&&(r.isOtherAnswer=!0)):"checkbox"==r.question.type?(r.questionResponse.selectedAnswers&&r.questionResponse.selectedAnswers.length?r.selectedAnswer=!0:r.questionResponse.selectedAnswers=[],r.questionResponse.other&&(r.isOtherAnswer=!0)):"grid"==r.question.type?r.question.grid.cellInputType||(r.question.grid.cellInputType="radio"):"division"==r.question.type?(r.computeDivisionSum=function(){r.divisionSum=0,r.question.divisionList.forEach(function(e){0==r.questionResponse[e.id]||r.questionResponse[e.id]?r.divisionSum+=r.questionResponse[e.id]:(r.questionResponse[e.id]=null,r.divisionSum+=0)})},r.computeDivisionSum()):"date"!=r.question.type&&"datetime"!=r.question.type&&"time"!=r.question.type||r.questionResponse.answer&&(r.questionResponse.answer=new Date(r.questionResponse.answer)),r.isAnswerSelected=!1,r.initialized=!0},e.$watch(function(e){return e.ctrl.questionResponse},function(e,n){"undefined"!=typeof r.questionResponse&&r.questionResponse||(r.questionResponse={})}),r.selectedAnswerChanged=function(){delete r.questionResponse.other,r.isOtherAnswer=!1,r.answerChanged()},r.otherAnswerRadioChanged=function(){void 0,r.isOtherAnswer&&(r.questionResponse.selectedAnswer=null),r.answerChanged()},r.otherAnswerCheckboxChanged=function(){r.isOtherAnswer||delete r.questionResponse.other,r.selectedAnswer=!(!r.questionResponse.selectedAnswers.length&&!r.isOtherAnswer)||null,r.answerChanged()},r.toggleSelectedAnswer=function(e){"undefined"!=typeof r.questionResponse.selectedAnswers&&r.questionResponse.selectedAnswers||(r.questionResponse.selectedAnswers=[]),r.questionResponse.selectedAnswers.indexOf(e.id)===-1?r.questionResponse.selectedAnswers.push(e.id):r.questionResponse.selectedAnswers.splice(r.questionResponse.selectedAnswers.indexOf(e.id),1),r.selectedAnswer=!(!r.questionResponse.selectedAnswers.length&&!r.isOtherAnswer)||null,r.answerChanged()},r.answerChanged=function(){r.onResponseChanged&&r.onResponseChanged()},1===angular.version.major&&angular.version.minor<5&&this.$onInit()}],link:function(e,n,t,r){var s=e.ctrl;s.print=r.print}}}),angular.module("mwFormViewer").directive("mwFormConfirmationPage",function(){return{replace:!0,restrict:"AE",require:"^mwFormViewer",scope:{submitStatus:"=",confirmationMessage:"=",readOnly:"=?"},templateUrl:"/mw-form-confirmation-page.html",controllerAs:"ctrl",bindToController:!0,controller:function(){},link:function(e,n,t,r){var s=e.ctrl;s.print=r.print}}}),angular.module("mwFormViewer").factory("FormCodeId",function(){var e=0;return{next:function(){return++e}}}).directive("mwFormCode",function(){return{replace:!0,restrict:"AE",require:"^mwFormViewer",scope:{code:"=?",options:"=?"},templateUrl:"/mw-form-code.html",controllerAs:"ctrl",bindToController:!0,controller:["$timeout","FormCodeId",function(e,n){var t=this;this.$onInit=function(){t.id=n.next();const e=window.location;for(var r=e.search.substring(1),s=r.split("&"),o=0;o<s.length;o++){var i=s[o].split("=");i[0]===t.code.text&&(t.code.response=decodeURIComponent(i[1]))}},1===angular.version.major&&angular.version.minor<5&&this.$onInit()}],link:function(e,n,t,r){var s=e.ctrl;s.print=r.print}}});